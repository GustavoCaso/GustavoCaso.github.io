<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Migrating millions of Redis keys without downtime &#183; Gustavo Caso</title><meta name=title content="Migrating millions of Redis keys without downtime &#183; Gustavo Caso"><meta name=keywords content="ruby, redis,"><link rel=canonical href=https://www.gustavocaso.dev/posts/migrating-millions-of-redis-keys-without-downtime/><link type=text/css rel=stylesheet href=/css/main.bundle.min.c6116b9ed1c907a8c0eb015f377d3eecc07e448d75729e31fc3de5881465c6c172ba9fa9a6800c030116caf2a110d92242bb816639484ca791f7cd107a8d49b5.css integrity="sha512-xhFrntHJB6jA6wFfN30+7MB+RI11cp4x/D3liBRlxsFyup+ppoAMAwEWyvKhENkiQruBZjlITKeR980Qeo1JtQ=="><script type=text/javascript src=/js/appearance.min.0c2efa25b877bbb1cbe22c984957864f28de3072dda887632dd30d5e82bedd61a9cc3e2e996c81d9da4acbee3d4aee6b45d4a339fa66ee22f518123eb89a1b2a.js integrity="sha512-DC76Jbh3u7HL4iyYSVeGTyjeMHLdqIdjLdMNXoK+3WGpzD4umWyB2dpKy+49Su5rRdSjOfpm7iL1GBI+uJobKg=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.911bd9741247c092f3a38757ca26b07e6bf319209e5162bbc5a609bae50fa2ea13b3c09f8f2c3d1cfd66c0b6885f0b2137bb43fee6404db177d90abde3c09547.js integrity="sha512-kRvZdBJHwJLzo4dXyiawfmvzGSCeUWK7xaYJuuUPouoTs8Cfjyw9HP1mwLaIXwshN7tD/uZATbF32Qq948CVRw==" data-copy data-copied></script>
<script src=/js/zoom.min.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Migrating millions of Redis keys without downtime"><meta property="og:description" content="Last year in September I joined the Job Patterns team at Shopify.
The mission of the team is to provide a stable platform so that developers can write their background jobs to power one of the biggest e-commerce platforms in the world."><meta property="og:type" content="article"><meta property="og:url" content="https://www.gustavocaso.dev/posts/migrating-millions-of-redis-keys-without-downtime/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-04-30T00:00:00+00:00"><meta property="article:modified_time" content="2019-04-30T00:00:00+00:00"><meta property="og:site_name" content="Gustavo Caso"><meta name=twitter:card content="summary"><meta name=twitter:title content="Migrating millions of Redis keys without downtime"><meta name=twitter:description content="Last year in September I joined the Job Patterns team at Shopify.
The mission of the team is to provide a stable platform so that developers can write their background jobs to power one of the biggest e-commerce platforms in the world."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Migrating millions of Redis keys without downtime","headline":"Migrating millions of Redis keys without downtime","abstract":"Last year in September I joined the Job Patterns team at Shopify.\nThe mission of the team is to provide a stable platform so that developers can write their background jobs to power one of the biggest e-commerce platforms in the world.","inLanguage":"en","url":"https:\/\/www.gustavocaso.dev\/posts\/migrating-millions-of-redis-keys-without-downtime\/","author":{"@type":"Person","name":"Gustavo Caso"},"copyrightYear":"2019","dateCreated":"2019-04-30T00:00:00\u002b00:00","datePublished":"2019-04-30T00:00:00\u002b00:00","dateModified":"2019-04-30T00:00:00\u002b00:00","keywords":["ruby"," redis"],"mainEntityOfPage":"true","wordCount":"968"}]</script><meta name=author content="Gustavo Caso"><link href=mailto:gustavocaso@gmail.com rel=me><link href=https://github.com/GustavoCaso rel=me><link href=https://www.linkedin.com/in/gustavocaso/ rel=me><script src=/lib/jquery/jquery.slim.min.js integrity></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Gustavo Caso</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12"><a href=/posts/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Posts>Posts</p></a><a href=/tags/ class="flex items-center"><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=Tags>Tags</p></a></nav><div class="flex md:hidden items-center space-x-5 md:ml-12"><span></span></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-auto overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Posts>Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center"><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=Tags>Tags</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Migrating millions of Redis keys without downtime</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2019-04-30 00:00:00 +0000 UTC">30 April 2019</time><span class="px-2 text-primary-500">&#183;</span><span>968 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">5 mins</span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/ruby/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">ruby</span></span></span>
<span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/redis/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">redis</span></span></span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first sm:max-w-prose lg:ml-auto px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#improving-performance>Improving performance</a></li><li><a href=#implementation>Implementation</a></li></ul></nav></div></details><details class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#improving-performance>Improving performance</a></li><li><a href=#implementation>Implementation</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><p>Last year in September I joined the Job Patterns team at <a href=https://www.shopify.com/ target=_blank>Shopify</a>.</p><p>The mission of the team is to provide a stable platform so that developers can write their background jobs to power one of the biggest e-commerce platforms in the world.</p><p>Since I joined, I have been gathering context around the various components that create the unique Shopify ecosystem.</p><p>To provide some context, Shopify is a <a href=https://stackshare.io/shopify/e-commerce-at-scale-inside-shopifys-tech-stack target=_blank>massive Ruby on Rails monolith</a> application and the background job architecture consists of <a href=https://edgeguides.rubyonrails.org/active_job_basics.html target=_blank>ActiveJob</a>, <a href=https://github.com/resque/resque target=_blank>Resque</a>, and <a href=https://redis.io/ target=_blank>Redis</a>. Besides the functionality that those libraries provide by default, we have created many additional modules that allow developers to define custom behaviour for their jobs: <code>Locking</code>, <code>LockQueue</code>, <code>Concurrency</code>, <code>Retry</code>, <code>Status</code>, and many more.</p><p>At Shopify, we have many Redis instances; Each instance stores information that belongs to different parts of the platform.</p><p>This post is going to focus on how we managed to migrate millions of keys from one of our Redis instances to another without downtime or incidents.</p><p>The module we&rsquo;ll be discussing here is the <code>Locking</code> module. Developers use this module to prevent multiple jobs of the same class with the same arguments to be executed by multiple processes at the same time. It provides the same functionality as <a href=https://github.com/mhenrixon/sidekiq-unique-jobs target=_blank>unique jobs</a> for Sidekiq.</p><p>Before enqueuing the job, it checks for the existence of the lock key. If the lock key does not exist, we acquire it until the job is done and finally release it. If the lock key does exist at the time of enqueueing it means that another job already exists, so we do not enqueue the new job.</p><div id=improving-performance class=anchor></div><h2 class="relative group">Improving performance
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#improving-performance aria-label=Anchor>#</a></span></h2><p>At the current growth rate of Shopify, we are looking into multiple ways to optimize the background jobs infrastructure for performance.</p><p>To reduce load from a single Redis for jobs queues, we plan on deploying more Redis instances so we can multiplex both the enqueue and dequeue operations.</p><p>A blocker for this idea is that we would need to know at all times where the unique locks are stored 🤔.</p><p>We decided on the solution to move lock keys from the Redis instance holding the queue information to a separate Redis instance. That way, we know at all times where the lock keys are stored unlike job queues that could span across multiple Redis instances in the future.</p><p>We process hundreds of thousands of jobs per minute, and those jobs are time-sensitive, so stopping the system, migrating the keys and deploying the changes is not a possible solution for us. We, therefore, had to perform the migration without a maintenance window or downtime.</p><p>How did we manage to achieve this?</p><p>We devised a 3-step plan that would allow us to do it. All steps required code changes in the application, so the full migration took roughly 2 weeks.</p><div id=implementation class=anchor></div><h2 class="relative group">Implementation
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implementation aria-label=Anchor>#</a></span></h2><p>Let&rsquo;s introduce our <code>Locking</code> module. The following is going to be a simplified version of the one currently maintained at Shopify:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>class</span> <span class=nc>Locking</span>
</span></span><span class=line><span class=cl>  <span class=no>AlreadyAcquireLockError</span> <span class=o>=</span> <span class=no>Class</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>StandardError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kp>attr_reader</span> <span class=ss>:lock_key</span><span class=p>,</span> <span class=ss>:token</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=ss>token</span><span class=p>:</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=vi>@lock_key</span> <span class=o>=</span> <span class=n>lock_key</span>
</span></span><span class=line><span class=cl>    <span class=vi>@token</span> <span class=o>=</span> <span class=n>token</span>
</span></span><span class=line><span class=cl>    <span class=vi>@have_lock</span> <span class=o>=</span> <span class=kp>false</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>have_lock?</span>
</span></span><span class=line><span class=cl>    <span class=vi>@have_lock</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>acquire</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=no>AlreadyAcquireLockError</span> <span class=k>if</span> <span class=n>have_lock?</span>
</span></span><span class=line><span class=cl>    <span class=vi>@have_lock</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=ss>ex</span><span class=p>:</span> <span class=n>duration</span><span class=p>,</span> <span class=ss>nx</span><span class=p>:</span> <span class=kp>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>relase</span>
</span></span><span class=line><span class=cl>    <span class=n>redis</span><span class=o>.</span><span class=n>del</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=vi>@have_lock</span> <span class=o>=</span> <span class=kp>false</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>locked?</span>
</span></span><span class=line><span class=cl>    <span class=n>redis</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>redis</span>
</span></span><span class=line><span class=cl>    <span class=no>Resque</span><span class=o>.</span><span class=n>redis</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>In the following steps, we will refer to the Redis instance holding the queue information as the <code>jobs</code> Redis (the source of the migration), and the Redis instance holding the locks information as the <code>locks</code> Redis (the destination of the migration).</p><p><strong>First Step:</strong></p><p>We modify the <code>locked?</code> method to check on the locks Redis and then on the resque Redis. With this change, the functionality stays the same, but we introduce the locks Redis as a new dependency.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>def</span> <span class=nf>locked?</span>
</span></span><span class=line><span class=cl>  <span class=n>redises</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>redis</span><span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>(</span><span class=kp>true</span><span class=p>)</span> <span class=k>if</span> <span class=n>redis</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=kp>false</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>redis</span>
</span></span><span class=line><span class=cl>  <span class=no>Resque</span><span class=o>.</span><span class=n>redis</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>redises</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span><span class=no>Lock</span><span class=o>.</span><span class=n>redis</span><span class=p>,</span> <span class=n>redis</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p><strong>Second Step:</strong></p><p>We are going to start <code>acquiring</code> the lock key on the <code>locks</code> Redis. The <code>release</code> method tries to release the lock from the <code>locks</code> Redis instance first, and if not successful, it will try releasing the lock from the Resque Redis instance. The <code>locked?</code> method stays the same as in the first step.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>def</span> <span class=nf>acquire</span>
</span></span><span class=line><span class=cl>  <span class=k>raise</span> <span class=no>AlreadyAcquireLockError</span> <span class=k>if</span> <span class=n>have_lock?</span>
</span></span><span class=line><span class=cl>  <span class=vi>@have_lock</span> <span class=o>=</span> <span class=n>lock_redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=ss>ex</span><span class=p>:</span> <span class=n>duration</span><span class=p>,</span> <span class=ss>nx</span><span class=p>:</span> <span class=kp>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>release</span>
</span></span><span class=line><span class=cl>  <span class=n>redises</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>redis</span><span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=c1># redis returns the number of keys deleted</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>redis</span><span class=o>.</span><span class=n>del</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>      <span class=vi>@have_lock</span> <span class=o>=</span> <span class=kp>false</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>redis</span>
</span></span><span class=line><span class=cl>  <span class=no>Resque</span><span class=o>.</span><span class=n>redis</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lock_redis</span>
</span></span><span class=line><span class=cl>  <span class=no>Lock</span><span class=o>.</span><span class=n>redis</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>redises</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span><span class=n>lock_redis</span><span class=p>,</span> <span class=n>redis</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p><strong>Note:</strong> After deploying this change, we monitored the platform for a couple of days to make sure everything was working as expected (meaning, lock keys were being acquired and released without any issue).</p><p><strong>Last Step:</strong></p><p>We change all the code to make sure that the only Redis instance involved with the <code>Locking</code> module is the <code>locks</code> Redis. All acquiring, releasing and checking actions of the keys have now been migrated over.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=kp>private</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>redis</span>
</span></span><span class=line><span class=cl>  <span class=no>Lock</span><span class=o>.</span><span class=n>redis</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>With these steps, we were able to migrate the lock keys successfully without impacting the platform 🎉 🎉.</p><p>Before starting the migration we asked ourselves questions like: Would the <code>locks</code> Redis be able to handle the load? Is the <code>locks</code> Redis a single point of failure?</p><p>The changes weren’t as straightforward as described above. There were other components involved, many tests to modify and some infrastructure changes to be done in other areas for this to happen but those are out of the scope of the post.</p><p>Of course, there is no simple, one-size-fits-all solution, but I wanted to share our approach with everyone, and hopefully, if you encounter a similar situation this could be of use.</p><p>If you have any thoughts or questions, please share, and I will be happy to answer in the comments.</p></br></br></div><script>var oid="views_posts/migrating-millions-of-redis-keys-without-downtime.md",oid_likes="likes_posts/migrating-millions-of-redis-keys-without-downtime.md"</script><script type=text/javascript src=/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js integrity="sha512-DkmXO0rQo4LHxgEti/+CJjFmQtqrxPiiBHe9CGdPPabi+pk7wgrU9R58W7aOb5E6IHp8T+N+oOe4BolK/OCmTg=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/summer-resolutions_/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Summer Resolutions 2018</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2018-09-23 00:00:00 +0000 UTC">23 September 2018</time></span></span></a></span>
<span><a class="flex text-right group ml-3" href=/posts/when-open-source-has-less-benefits/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">When open source has less benefits</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2019-11-15 00:00:00 +0000 UTC">15 November 2019</time></span></span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
Gustavo Caso</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.35c1113bcc16c5a59bf031082f9e63822aa95280423881a7847a7ff33a16e6299ce6a840d9ef4e10d947e030a18f3f20359afb2ec0f35967484b9a9360ac3145.js integrity="sha512-NcERO8wWxaWb8DEIL55jgiqpUoBCOIGnhHp/8zoW5imc5qhA2e9OENlH4DChjz8gNZr7LsDzWWdIS5qTYKwxRQ=="></script></footer></div></body></html>